'use client';
import{__rest}from"tslib";import{jsx,jsxs,Fragment}from"react/jsx-runtime";import{comboboxReducer}from"./combobox.reducer.js";import{ComboboxActionEnum}from"./Combobox.types.js";import{ComboboxGroup}from"./ComboboxGroup/ComboboxGroup.js";import{ComboboxOption}from"./ComboboxOption/ComboboxOption.js";import{useCombobox}from"./use-combobox.hook.js";import{useFormControlContext}from"../FormControl/FormControl.context.js";import{useInputGroupContext}from"../InputGroup/InputGroup.context.js";import Spinner from"../Spinner/Spinner.js";import{useMergeRefs,FloatingPortal}from"@floating-ui/react";import{useKeypress}from"../../hooks/use-keypress.js";import{useVerticalArrows}from"../../hooks/use-vertical-arrows.hook.js";import{XMarkIcon}from"../../icons/XMark.js";import{useComponentTheme}from"../../theme/theme.context.js";import{usePropId}from"../../utils/usePropId.js";import{forwardRef,useId,useReducer,useState,useRef,useEffect,useLayoutEffect,cloneElement}from"react";import{ComboboxContextProvider}from"./Combobox.context.js";import{CaretUpDown}from"../../icons/CaretUpDown.js";const defaultProps={clearable:!0,closeOnEscape:!0,closeOnSelect:!0,color:"dark",disabled:!1,loading:!1,maxHeight:250,minWidth:250,mode:"spacey",multiple:!1,offset:5,optionColor:"gray",radius:"lg",searchable:!0,shadow:"none",size:"md",tone:"light",validation:"none",withRing:!0},_Combobox=forwardRef(((e,o)=>{var s,t,a,n;const l=useComponentTheme("Combobox"),r=Object.assign(Object.assign(Object.assign(Object.assign({},defaultProps),useFormControlContext()),useInputGroupContext()),e),{children:i,className:c,clearable:u,closeOnEscape:d,closeOnSelect:m,color:p,controlId:b,initialValue:h,leftIcon:x,loading:f,maxHeight:g,minWidth:C,mode:j,multiple:v,offset:y,onChange:O,onSearch:E,optionColor:R,placeholder:N,radius:w,searchable:I,shadow:A,size:S,tone:z,validation:_,value:k,withRing:P}=r,F=__rest(r,["children","className","clearable","closeOnEscape","closeOnSelect","color","controlId","initialValue","leftIcon","loading","maxHeight","minWidth","mode","multiple","offset","onChange","onSearch","optionColor","placeholder","radius","searchable","shadow","size","tone","validation","value","withRing"]),G=usePropId(e.id),W=useId(),L=usePropId(b),M=e.disabled||f,B=!!x,V=!0,[$,H]=useReducer(comboboxReducer,{multiple:v||!1,initialValue:h,onChange:O,options:[],selectedOptions:[],search:"",searching:!1}),[K,D]=useState([]),[T,U]=useState(""),[X,q]=useState(l.base({className:c,color:p,disabled:M,hasLeftIcon:B,hasRightIcon:V,radius:w,shadow:A,size:S,tone:z,validation:_,withRing:P})),[J,Q]=useState(null),Y=useRef(null),Z=useRef(null),ee=useRef(null),oe={externalSearch:!!E,mode:j,multiple:v,optionColor:R,radius:w,size:S,state:$,dispatch:H},{x:se,y:te,reference:ae,floating:ne,strategy:le,getFloatingProps:re,open:ie,setOpen:ce}=useCombobox({offset:y}),ue=useMergeRefs([ae,Y,o||null]),de=useMergeRefs([Z,ne]),me=l.wrapper({disabled:M}),pe=l.noResults({size:S}),be=x?l.icon({tone:z,size:S,className:x.props.className}):null,he=l.leftIconWrapper({size:S}),xe=l.icon({tone:z,size:S}),fe=l.rightIconWrapper({color:p,size:S});useEffect((()=>{Y.current&&Q(Y.current.getBoundingClientRect().width)}),[]),useEffect((()=>{k?v&&Array.isArray(k)&&k.length>0?H({type:ComboboxActionEnum.init_multi_select,payload:{values:k}}):v||"string"!=typeof k||H({type:ComboboxActionEnum.single_select,payload:{value:k}}):H({type:ComboboxActionEnum.reset,payload:null})}),[k,v]),useEffect((()=>{var e;ie&&(null===(e=ee.current)||void 0===e||e.focus()),je()}),[ie]),useKeypress("Escape",!0,(()=>{H({type:ComboboxActionEnum.search_reset,payload:null}),ie&&d&&ce(!1)})),useKeypress("Backspace",ie,(()=>{$.search||H({type:ComboboxActionEnum.remove_last,payload:null})})),useKeypress("Enter",!0,(()=>{var e;if(!$.searching)return;const o=null===(e=Z.current)||void 0===e?void 0:e.querySelector('button[aria-hidden="false"]:not([aria-disabled="true"])');o&&o.click()})),useLayoutEffect((()=>{setTimeout((()=>{Z.current&&D(Array.from(Z.current.querySelectorAll('button[aria-hidden="false"][aria-disabled="false"]')))}),1),je()}),[$.search]),useEffect((()=>{ie&&m&&ce(!1)}),[$.selectedOptions]),useVerticalArrows(K,ie);const ge=jsx("div",Object.assign({className:X},{children:jsxs("div",Object.assign({className:l.tagWrapper({size:S})},{children:[v&&(null===(s=$.selectedOptions)||void 0===s?void 0:s.map(((e,o)=>jsxs("div",Object.assign({className:l.tag({disabled:M,radius:w,size:S,tone:z})},{children:[jsx("button",Object.assign({type:"button",disabled:M,"aria-label":`Remove ${e.label}`,className:l.tagButton({color:p,disabled:M}),onClick:o=>{H({type:ComboboxActionEnum.multi_select,payload:{value:e.value,toggle:!0}}),o.stopPropagation()}},{children:jsx("span",Object.assign({className:l.tagButtonIcon()},{children:"âœ•"}))})),jsx("span",{children:e.label})]}),`label-${o}`)))),(!v||ie||0===$.selectedOptions.length)&&jsx("input",{id:L,ref:ee,disabled:M,className:l.input({size:S}),role:"combobox","aria-controls":W,"aria-autocomplete":I?"both":"list","aria-haspopup":"listbox","aria-expanded":ie,value:$.searching?$.search:(v?"":null===(t=$.selectedOptions[0])||void 0===t?void 0:t.label)||"",placeholder:$.selectedOptions.length?"":N,readOnly:!I,autoComplete:"off",onBlur:()=>H({type:ComboboxActionEnum.search_reset,payload:null}),onChange:e=>{H({type:ComboboxActionEnum.search_start,payload:{search:e.target.value}}),E&&E(e.target.value),ie||ce(!0)},type:"text"})]}))})),Ce="solid"===z?"slate":"gray",je=()=>{Z.current&&U(l.list({size:S,open:ie,mode:j,radius:w,shadow:A}))};return useEffect((()=>{var e,o;if(!(null===(e=Y.current)||void 0===e?void 0:e.dataset))return;const s=Object.assign({},null===(o=Y.current)||void 0===o?void 0:o.dataset),t=s.hasOwnProperty("hasLeftElement")&&"true"===s.hasLeftElement,a=s.hasOwnProperty("hasRightElement")&&"true"===s.hasRightElement;q(l.base({className:c,color:p,disabled:M,hasLeftElement:t,hasLeftIcon:B,hasRightElement:a,hasRightIcon:V,radius:w,shadow:A,size:S,tone:z,validation:_,withRing:P}))}),[c,p,M,B,V,w,A,S,l,z,_,P]),jsx(Fragment,{children:jsxs("div",Object.assign({id:G,ref:ue,className:me,onClick:()=>{var e;ie||M||ce(!0),null===(e=null==ee?void 0:ee.current)||void 0===e||e.focus()}},F,{children:[x&&jsx("span",Object.assign({className:he},{children:cloneElement(x,{className:be})})),ge,f&&jsx("span",Object.assign({className:fe},{children:jsx(Spinner,{size:S,color:Ce})})),!f&&u&&(null===(a=$.selectedOptions)||void 0===a?void 0:a.length)>0&&jsx("button",Object.assign({"aria-label":"Clear",type:"button",disabled:M,onClick:e=>{H({type:ComboboxActionEnum.reset,payload:null}),H({type:ComboboxActionEnum.search_reset,payload:null}),e.stopPropagation()},className:fe},{children:jsx(XMarkIcon,{className:xe})})),!f&&(!u||0===(null===(n=$.selectedOptions)||void 0===n?void 0:n.length))&&jsx("div",Object.assign({className:fe},{children:jsx(CaretUpDown,{className:xe})})),jsx(ComboboxContextProvider,Object.assign({value:oe},{children:jsx(FloatingPortal,{children:jsxs("div",Object.assign({id:W,role:"listbox",ref:de,className:T,style:{display:ie?"block":"none",opacity:ie&&!M?1:0,maxHeight:`${g}px`,minWidth:`${C}px`,maxWidth:`${J}px`,position:le,top:te&&te>0&&te!==1/0?te:0,left:se||0}},re,{children:[0===(null==K?void 0:K.length)&&$.searching&&jsx("div",Object.assign({className:pe},{children:"No results"})),i]}))})}))]}))})}));_Combobox.displayName="Combobox";const Combobox=Object.assign(_Combobox,{Group:ComboboxGroup,Option:ComboboxOption});export{Combobox as default};
