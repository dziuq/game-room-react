"use strict";var errors=require("../../utils/errors.cjs"),PanSession=require("../pan/PanSession.cjs"),lock=require("./utils/lock.cjs"),isRefObject=require("../../utils/is-ref-object.cjs"),addPointerEvent=require("../../events/add-pointer-event.cjs"),constraints=require("./utils/constraints.cjs"),models=require("../../projection/geometry/models.cjs"),eachAxis=require("../../projection/utils/each-axis.cjs"),measure=require("../../projection/utils/measure.cjs"),eventInfo=require("../../events/event-info.cjs"),conversion=require("../../projection/geometry/conversion.cjs"),addDomEvent=require("../../events/add-dom-event.cjs"),deltaCalc=require("../../projection/geometry/delta-calc.cjs"),mix=require("../../utils/mix.cjs"),units=require("../../value/types/numbers/units.cjs"),motionValue=require("../../animation/interfaces/motion-value.cjs"),frame=require("../../frameloop/frame.cjs");const elementDragControls=new WeakMap;class VisualElementDragControls{constructor(t){this.openGlobalLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=models.createBox(),this.visualElement=t}start(t,{snapToCursor:s=!1}={}){const{presenceContext:e}=this.visualElement;if(e&&!1===e.isPresent)return;this.panSession=new PanSession.PanSession(t,{onSessionStart:t=>{this.stopAnimation(),s&&this.snapToCursor(eventInfo.extractEventInfo(t,"page").point)},onStart:(t,s)=>{const{drag:e,dragPropagation:i,onDragStart:n}=this.getProps();if(e&&!i&&(this.openGlobalLock&&this.openGlobalLock(),this.openGlobalLock=lock.getGlobalLock(e),!this.openGlobalLock))return;this.isDragging=!0,this.currentDirection=null,this.resolveConstraints(),this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!0,this.visualElement.projection.target=void 0),eachAxis.eachAxis((t=>{let s=this.getAxisMotionValue(t).get()||0;if(units.percent.test(s)){const{projection:e}=this.visualElement;if(e&&e.layout){const i=e.layout.layoutBox[t];if(i){s=deltaCalc.calcLength(i)*(parseFloat(s)/100)}}}this.originPoint[t]=s})),n&&frame.frame.update((()=>n(t,s)),!1,!0);const{animationState:o}=this.visualElement;o&&o.setActive("whileDrag",!0)},onMove:(t,s)=>{const{dragPropagation:e,dragDirectionLock:i,onDirectionLock:n,onDrag:o}=this.getProps();if(!e&&!this.openGlobalLock)return;const{offset:r}=s;if(i&&null===this.currentDirection)return this.currentDirection=getCurrentDirection(r),void(null!==this.currentDirection&&n&&n(this.currentDirection));this.updateAxis("x",s.point,r),this.updateAxis("y",s.point,r),this.visualElement.render(),o&&o(t,s)},onSessionEnd:(t,s)=>this.stop(t,s)},{transformPagePoint:this.visualElement.getTransformPagePoint()})}stop(t,s){const e=this.isDragging;if(this.cancel(),!e)return;const{velocity:i}=s;this.startAnimation(i);const{onDragEnd:n}=this.getProps();n&&frame.frame.update((()=>n(t,s)))}cancel(){this.isDragging=!1;const{projection:t,animationState:s}=this.visualElement;t&&(t.isAnimationBlocked=!1),this.panSession&&this.panSession.end(),this.panSession=void 0;const{dragPropagation:e}=this.getProps();!e&&this.openGlobalLock&&(this.openGlobalLock(),this.openGlobalLock=null),s&&s.setActive("whileDrag",!1)}updateAxis(t,s,e){const{drag:i}=this.getProps();if(!e||!shouldDrag(t,i,this.currentDirection))return;const n=this.getAxisMotionValue(t);let o=this.originPoint[t]+e[t];this.constraints&&this.constraints[t]&&(o=constraints.applyConstraints(o,this.constraints[t],this.elastic[t])),n.set(o)}resolveConstraints(){const{dragConstraints:t,dragElastic:s}=this.getProps(),{layout:e}=this.visualElement.projection||{},i=this.constraints;t&&isRefObject.isRefObject(t)?this.constraints||(this.constraints=this.resolveRefConstraints()):this.constraints=!(!t||!e)&&constraints.calcRelativeConstraints(e.layoutBox,t),this.elastic=constraints.resolveDragElastic(s),i!==this.constraints&&e&&this.constraints&&!this.hasMutatedConstraints&&eachAxis.eachAxis((t=>{this.getAxisMotionValue(t)&&(this.constraints[t]=constraints.rebaseAxisConstraints(e.layoutBox[t],this.constraints[t]))}))}resolveRefConstraints(){const{dragConstraints:t,onMeasureDragConstraints:s}=this.getProps();if(!t||!isRefObject.isRefObject(t))return!1;const e=t.current;errors.invariant(null!==e,"If `dragConstraints` is set as a React ref, that ref must be passed to another component's `ref` prop.");const{projection:i}=this.visualElement;if(!i||!i.layout)return!1;const n=measure.measurePageBox(e,i.root,this.visualElement.getTransformPagePoint());let o=constraints.calcViewportConstraints(i.layout.layoutBox,n);if(s){const t=s(conversion.convertBoxToBoundingBox(o));this.hasMutatedConstraints=!!t,t&&(o=conversion.convertBoundingBoxToBox(t))}return o}startAnimation(t){const{drag:s,dragMomentum:e,dragElastic:i,dragTransition:n,dragSnapToOrigin:o,onDragTransitionEnd:r}=this.getProps(),a=this.constraints||{},c=eachAxis.eachAxis((r=>{if(!shouldDrag(r,s,this.currentDirection))return;let c=a&&a[r]||{};o&&(c={min:0,max:0});const l=i?200:1e6,u=i?40:1e7,h={type:"inertia",velocity:e?t[r]:0,bounceStiffness:l,bounceDamping:u,timeConstant:750,restDelta:1,restSpeed:10,...n,...c};return this.startAxisValueAnimation(r,h)}));return Promise.all(c).then(r)}startAxisValueAnimation(t,s){const e=this.getAxisMotionValue(t);return e.start(motionValue.animateMotionValue(t,e,0,s))}stopAnimation(){eachAxis.eachAxis((t=>this.getAxisMotionValue(t).stop()))}getAxisMotionValue(t){const s="_drag"+t.toUpperCase(),e=this.visualElement.getProps(),i=e[s];return i||this.visualElement.getValue(t,(e.initial?e.initial[t]:void 0)||0)}snapToCursor(t){eachAxis.eachAxis((s=>{const{drag:e}=this.getProps();if(!shouldDrag(s,e,this.currentDirection))return;const{projection:i}=this.visualElement,n=this.getAxisMotionValue(s);if(i&&i.layout){const{min:e,max:o}=i.layout.layoutBox[s];n.set(t[s]-mix.mix(e,o,.5))}}))}scalePositionWithinConstraints(){if(!this.visualElement.current)return;const{drag:t,dragConstraints:s}=this.getProps(),{projection:e}=this.visualElement;if(!isRefObject.isRefObject(s)||!e||!this.constraints)return;this.stopAnimation();const i={x:0,y:0};eachAxis.eachAxis((t=>{const s=this.getAxisMotionValue(t);if(s){const e=s.get();i[t]=constraints.calcOrigin({min:e,max:e},this.constraints[t])}}));const{transformTemplate:n}=this.visualElement.getProps();this.visualElement.current.style.transform=n?n({},""):"none",e.root&&e.root.updateScroll(),e.updateLayout(),this.resolveConstraints(),eachAxis.eachAxis((s=>{if(!shouldDrag(s,t,null))return;const e=this.getAxisMotionValue(s),{min:n,max:o}=this.constraints[s];e.set(mix.mix(n,o,i[s]))}))}addListeners(){if(!this.visualElement.current)return;elementDragControls.set(this.visualElement,this);const t=this.visualElement.current,s=addPointerEvent.addPointerEvent(t,"pointerdown",(t=>{const{drag:s,dragListener:e=!0}=this.getProps();s&&e&&this.start(t)})),e=()=>{const{dragConstraints:t}=this.getProps();isRefObject.isRefObject(t)&&(this.constraints=this.resolveRefConstraints())},{projection:i}=this.visualElement,n=i.addEventListener("measure",e);i&&!i.layout&&(i.root&&i.root.updateScroll(),i.updateLayout()),e();const o=addDomEvent.addDomEvent(window,"resize",(()=>this.scalePositionWithinConstraints())),r=i.addEventListener("didUpdate",(({delta:t,hasLayoutChanged:s})=>{this.isDragging&&s&&(eachAxis.eachAxis((s=>{const e=this.getAxisMotionValue(s);e&&(this.originPoint[s]+=t[s].translate,e.set(e.get()+t[s].translate))})),this.visualElement.render())}));return()=>{o(),s(),n(),r&&r()}}getProps(){const t=this.visualElement.getProps(),{drag:s=!1,dragDirectionLock:e=!1,dragPropagation:i=!1,dragConstraints:n=!1,dragElastic:o=constraints.defaultElastic,dragMomentum:r=!0}=t;return{...t,drag:s,dragDirectionLock:e,dragPropagation:i,dragConstraints:n,dragElastic:o,dragMomentum:r}}}function shouldDrag(t,s,e){return!(!0!==s&&s!==t||null!==e&&e!==t)}function getCurrentDirection(t,s=10){let e=null;return Math.abs(t.y)>s?e="y":Math.abs(t.x)>s&&(e="x"),e}exports.VisualElementDragControls=VisualElementDragControls,exports.elementDragControls=elementDragControls;
