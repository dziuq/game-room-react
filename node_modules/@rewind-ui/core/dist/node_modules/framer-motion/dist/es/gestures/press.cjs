"use strict";var eventInfo=require("../events/event-info.cjs"),addDomEvent=require("../events/add-dom-event.cjs"),addPointerEvent=require("../events/add-pointer-event.cjs"),Feature=require("../motion/features/Feature.cjs"),pipe=require("../utils/pipe.cjs"),lock=require("./drag/utils/lock.cjs"),isNodeOrChild=require("./utils/is-node-or-child.cjs"),noop=require("../utils/noop.cjs"),frame=require("../frameloop/frame.cjs");function fireSyntheticPointerEvent(e,t){if(!t)return;const s=new PointerEvent("pointer"+e);t(s,eventInfo.extractEventInfo(s))}class PressGesture extends Feature.Feature{constructor(){super(...arguments),this.removeStartListeners=noop.noop,this.removeEndListeners=noop.noop,this.removeAccessibleListeners=noop.noop,this.startPointerPress=(e,t)=>{if(this.removeEndListeners(),this.isPressing)return;const s=this.node.getProps(),n=addPointerEvent.addPointerEvent(window,"pointerup",((e,t)=>{if(!this.checkPressEnd())return;const{onTap:s,onTapCancel:n}=this.node.getProps();frame.frame.update((()=>{isNodeOrChild.isNodeOrChild(this.node.current,e.target)?s&&s(e,t):n&&n(e,t)}))}),{passive:!(s.onTap||s.onPointerUp)}),r=addPointerEvent.addPointerEvent(window,"pointercancel",((e,t)=>this.cancelPress(e,t)),{passive:!(s.onTapCancel||s.onPointerCancel)});this.removeEndListeners=pipe.pipe(n,r),this.startPress(e,t)},this.startAccessiblePress=()=>{const e=addDomEvent.addDomEvent(this.node.current,"keydown",(e=>{if("Enter"!==e.key||this.isPressing)return;this.removeEndListeners(),this.removeEndListeners=addDomEvent.addDomEvent(this.node.current,"keyup",(e=>{"Enter"===e.key&&this.checkPressEnd()&&fireSyntheticPointerEvent("up",((e,t)=>{const{onTap:s}=this.node.getProps();s&&frame.frame.update((()=>s(e,t)))}))})),fireSyntheticPointerEvent("down",((e,t)=>{this.startPress(e,t)}))})),t=addDomEvent.addDomEvent(this.node.current,"blur",(()=>{this.isPressing&&fireSyntheticPointerEvent("cancel",((e,t)=>this.cancelPress(e,t)))}));this.removeAccessibleListeners=pipe.pipe(e,t)}}startPress(e,t){this.isPressing=!0;const{onTapStart:s,whileTap:n}=this.node.getProps();n&&this.node.animationState&&this.node.animationState.setActive("whileTap",!0),s&&frame.frame.update((()=>s(e,t)))}checkPressEnd(){this.removeEndListeners(),this.isPressing=!1;return this.node.getProps().whileTap&&this.node.animationState&&this.node.animationState.setActive("whileTap",!1),!lock.isDragActive()}cancelPress(e,t){if(!this.checkPressEnd())return;const{onTapCancel:s}=this.node.getProps();s&&frame.frame.update((()=>s(e,t)))}mount(){const e=this.node.getProps(),t=addPointerEvent.addPointerEvent(this.node.current,"pointerdown",this.startPointerPress,{passive:!(e.onTapStart||e.onPointerStart)}),s=addDomEvent.addDomEvent(this.node.current,"focus",this.startAccessiblePress);this.removeStartListeners=pipe.pipe(t,s)}unmount(){this.removeStartListeners(),this.removeEndListeners(),this.removeAccessibleListeners()}}exports.PressGesture=PressGesture;
