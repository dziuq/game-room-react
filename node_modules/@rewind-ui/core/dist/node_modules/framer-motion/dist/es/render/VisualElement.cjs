"use strict";var errors=require("../utils/errors.cjs"),models=require("../projection/geometry/models.cjs"),isRefObject=require("../utils/is-ref-object.cjs"),index=require("../utils/reduced-motion/index.cjs"),state=require("../utils/reduced-motion/state.cjs"),subscriptionManager=require("../utils/subscription-manager.cjs"),index$1=require("../value/index.cjs"),is=require("../value/use-will-change/is.cjs"),isMotionValue=require("../value/utils/is-motion-value.cjs"),transform=require("./html/utils/transform.cjs"),isControllingVariants=require("./utils/is-controlling-variants.cjs"),isVariantLabel=require("./utils/is-variant-label.cjs"),motionValues=require("./utils/motion-values.cjs"),resolveVariants=require("./utils/resolve-variants.cjs"),warnOnce=require("../utils/warn-once.cjs"),definitions=require("../motion/features/definitions.cjs"),variantProps=require("./utils/variant-props.cjs"),store=require("./store.cjs"),frame=require("../frameloop/frame.cjs");const featureNames=Object.keys(definitions.featureDefinitions),numFeatures=featureNames.length,propEventHandlers=["AnimationStart","AnimationComplete","Update","BeforeLayoutMeasure","LayoutMeasure","LayoutAnimationStart","LayoutAnimationComplete"],numVariantProps=variantProps.variantProps.length;class VisualElement{constructor({parent:t,props:e,presenceContext:i,reducedMotionConfig:s,visualState:r},n={}){this.current=null,this.children=new Set,this.isVariantNode=!1,this.isControllingVariants=!1,this.shouldReduceMotion=null,this.values=new Map,this.features={},this.valueSubscriptions=new Map,this.prevMotionValues={},this.events={},this.propEventSubscriptions={},this.notifyUpdate=()=>this.notify("Update",this.latestValues),this.render=()=>{this.current&&(this.triggerBuild(),this.renderInstance(this.current,this.renderState,this.props.style,this.projection))},this.scheduleRender=()=>frame.frame.render(this.render,!1,!0);const{latestValues:o,renderState:a}=r;this.latestValues=o,this.baseTarget={...o},this.initialValues=e.initial?{...o}:{},this.renderState=a,this.parent=t,this.props=e,this.presenceContext=i,this.depth=t?t.depth+1:0,this.reducedMotionConfig=s,this.options=n,this.isControllingVariants=isControllingVariants.isControllingVariants(e),this.isVariantNode=isControllingVariants.isVariantNode(e),this.isVariantNode&&(this.variantChildren=new Set),this.manuallyAnimateOnMount=Boolean(t&&t.current);const{willChange:u,...l}=this.scrapeMotionValuesFromProps(e,{});for(const t in l){const e=l[t];void 0!==o[t]&&isMotionValue.isMotionValue(e)&&(e.set(o[t],!1),is.isWillChangeMotionValue(u)&&u.add(t))}}scrapeMotionValuesFromProps(t,e){return{}}mount(t){this.current=t,store.visualElementStore.set(t,this),this.projection&&!this.projection.instance&&this.projection.mount(t),this.parent&&this.isVariantNode&&!this.isControllingVariants&&(this.removeFromVariantTree=this.parent.addVariantChild(this)),this.values.forEach(((t,e)=>this.bindToMotionValue(e,t))),state.hasReducedMotionListener.current||index.initPrefersReducedMotion(),this.shouldReduceMotion="never"!==this.reducedMotionConfig&&("always"===this.reducedMotionConfig||state.prefersReducedMotion.current),"production"!==process.env.NODE_ENV&&warnOnce.warnOnce(!0!==this.shouldReduceMotion,"You have Reduced Motion enabled on your device. Animations may not appear as expected."),this.parent&&this.parent.children.add(this),this.update(this.props,this.presenceContext)}unmount(){store.visualElementStore.delete(this.current),this.projection&&this.projection.unmount(),frame.cancelFrame(this.notifyUpdate),frame.cancelFrame(this.render),this.valueSubscriptions.forEach((t=>t())),this.removeFromVariantTree&&this.removeFromVariantTree(),this.parent&&this.parent.children.delete(this);for(const t in this.events)this.events[t].clear();for(const t in this.features)this.features[t].unmount();this.current=null}bindToMotionValue(t,e){const i=transform.transformProps.has(t),s=e.on("change",(e=>{this.latestValues[t]=e,this.props.onUpdate&&frame.frame.update(this.notifyUpdate,!1,!0),i&&this.projection&&(this.projection.isTransformDirty=!0)})),r=e.on("renderRequest",this.scheduleRender);this.valueSubscriptions.set(t,(()=>{s(),r()}))}sortNodePosition(t){return this.current&&this.sortInstanceNodePosition&&this.type===t.type?this.sortInstanceNodePosition(this.current,t.current):0}loadFeatures({children:t,...e},i,s,r){let n,o;if("production"!==process.env.NODE_ENV&&s&&i){const t="You have rendered a `motion` component within a `LazyMotion` component. This will break tree shaking. Import and render a `m` component instead.";e.ignoreStrict?errors.warning(!1,t):errors.invariant(!1,t)}for(let t=0;t<numFeatures;t++){const i=featureNames[t],{isEnabled:s,Feature:r,ProjectionNode:a,MeasureLayout:u}=definitions.featureDefinitions[i];a&&(n=a),s(e)&&(!this.features[i]&&r&&(this.features[i]=new r(this)),u&&(o=u))}if(!this.projection&&n){this.projection=new n(this.latestValues,this.parent&&this.parent.projection);const{layoutId:t,layout:i,drag:s,dragConstraints:o,layoutScroll:a,layoutRoot:u}=e;this.projection.setOptions({layoutId:t,layout:i,alwaysMeasureLayout:Boolean(s)||o&&isRefObject.isRefObject(o),visualElement:this,scheduleRender:()=>this.scheduleRender(),animationType:"string"==typeof i?i:"both",initialPromotionConfig:r,layoutScroll:a,layoutRoot:u})}return o}updateFeatures(){for(const t in this.features){const e=this.features[t];e.isMounted?e.update():(e.mount(),e.isMounted=!0)}}triggerBuild(){this.build(this.renderState,this.latestValues,this.options,this.props)}measureViewportBox(){return this.current?this.measureInstanceViewportBox(this.current,this.props):models.createBox()}getStaticValue(t){return this.latestValues[t]}setStaticValue(t,e){this.latestValues[t]=e}makeTargetAnimatable(t,e=!0){return this.makeTargetAnimatableFromInstance(t,this.props,e)}update(t,e){(t.transformTemplate||this.props.transformTemplate)&&this.scheduleRender(),this.prevProps=this.props,this.props=t,this.prevPresenceContext=this.presenceContext,this.presenceContext=e;for(let e=0;e<propEventHandlers.length;e++){const i=propEventHandlers[e];this.propEventSubscriptions[i]&&(this.propEventSubscriptions[i](),delete this.propEventSubscriptions[i]);const s=t["on"+i];s&&(this.propEventSubscriptions[i]=this.on(i,s))}this.prevMotionValues=motionValues.updateMotionValuesFromProps(this,this.scrapeMotionValuesFromProps(t,this.prevProps),this.prevMotionValues),this.handleChildMotionValue&&this.handleChildMotionValue()}getProps(){return this.props}getVariant(t){return this.props.variants?this.props.variants[t]:void 0}getDefaultTransition(){return this.props.transition}getTransformPagePoint(){return this.props.transformPagePoint}getClosestVariantNode(){return this.isVariantNode?this:this.parent?this.parent.getClosestVariantNode():void 0}getVariantContext(t=!1){if(t)return this.parent?this.parent.getVariantContext():void 0;if(!this.isControllingVariants){const t=this.parent&&this.parent.getVariantContext()||{};return void 0!==this.props.initial&&(t.initial=this.props.initial),t}const e={};for(let t=0;t<numVariantProps;t++){const i=variantProps.variantProps[t],s=this.props[i];(isVariantLabel.isVariantLabel(s)||!1===s)&&(e[i]=s)}return e}addVariantChild(t){const e=this.getClosestVariantNode();if(e)return e.variantChildren&&e.variantChildren.add(t),()=>e.variantChildren.delete(t)}addValue(t,e){e!==this.values.get(t)&&(this.removeValue(t),this.bindToMotionValue(t,e)),this.values.set(t,e),this.latestValues[t]=e.get()}removeValue(t){this.values.delete(t);const e=this.valueSubscriptions.get(t);e&&(e(),this.valueSubscriptions.delete(t)),delete this.latestValues[t],this.removeValueFromRenderState(t,this.renderState)}hasValue(t){return this.values.has(t)}getValue(t,e){if(this.props.values&&this.props.values[t])return this.props.values[t];let i=this.values.get(t);return void 0===i&&void 0!==e&&(i=index$1.motionValue(e,{owner:this}),this.addValue(t,i)),i}readValue(t){var e;return void 0===this.latestValues[t]&&this.current?null!==(e=this.getBaseTargetFromProps(this.props,t))&&void 0!==e?e:this.readValueFromInstance(this.current,t,this.options):this.latestValues[t]}setBaseTarget(t,e){this.baseTarget[t]=e}getBaseTarget(t){var e;const{initial:i}=this.props,s="string"==typeof i||"object"==typeof i?null===(e=resolveVariants.resolveVariantFromProps(this.props,i))||void 0===e?void 0:e[t]:void 0;if(i&&void 0!==s)return s;const r=this.getBaseTargetFromProps(this.props,t);return void 0===r||isMotionValue.isMotionValue(r)?void 0!==this.initialValues[t]&&void 0===s?void 0:this.baseTarget[t]:r}on(t,e){return this.events[t]||(this.events[t]=new subscriptionManager.SubscriptionManager),this.events[t].add(e)}notify(t,...e){this.events[t]&&this.events[t].notify(...e)}}exports.VisualElement=VisualElement;
