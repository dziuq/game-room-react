"use strict";var eventInfo=require("../../events/event-info.cjs"),timeConversion=require("../../utils/time-conversion.cjs"),addPointerEvent=require("../../events/add-pointer-event.cjs"),pipe=require("../../utils/pipe.cjs"),distance=require("../../utils/distance.cjs"),isPrimaryPointer=require("../../events/utils/is-primary-pointer.cjs"),frame=require("../../frameloop/frame.cjs");class PanSession{constructor(t,e,{transformPagePoint:n}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!this.lastMoveEvent||!this.lastMoveEventInfo)return;const t=getPanInfo(this.lastMoveEventInfo,this.history),e=null!==this.startEvent,n=distance.distance2D(t.offset,{x:0,y:0})>=3;if(!e&&!n)return;const{point:i}=t,{timestamp:s}=frame.frameData;this.history.push({...i,timestamp:s});const{onStart:o,onMove:r}=this.handlers;e||(o&&o(this.lastMoveEvent,t),this.startEvent=this.lastMoveEvent),r&&r(this.lastMoveEvent,t)},this.handlePointerMove=(t,e)=>{this.lastMoveEvent=t,this.lastMoveEventInfo=transformPoint(e,this.transformPagePoint),frame.frame.update(this.updatePoint,!0)},this.handlePointerUp=(t,e)=>{if(this.end(),!this.lastMoveEvent||!this.lastMoveEventInfo)return;const{onEnd:n,onSessionEnd:i}=this.handlers,s=getPanInfo("pointercancel"===t.type?this.lastMoveEventInfo:transformPoint(e,this.transformPagePoint),this.history);this.startEvent&&n&&n(t,s),i&&i(t,s)},!isPrimaryPointer.isPrimaryPointer(t))return;this.handlers=e,this.transformPagePoint=n;const i=transformPoint(eventInfo.extractEventInfo(t),this.transformPagePoint),{point:s}=i,{timestamp:o}=frame.frameData;this.history=[{...s,timestamp:o}];const{onSessionStart:r}=e;r&&r(t,getPanInfo(i,this.history)),this.removeListeners=pipe.pipe(addPointerEvent.addPointerEvent(window,"pointermove",this.handlePointerMove),addPointerEvent.addPointerEvent(window,"pointerup",this.handlePointerUp),addPointerEvent.addPointerEvent(window,"pointercancel",this.handlePointerUp))}updateHandlers(t){this.handlers=t}end(){this.removeListeners&&this.removeListeners(),frame.cancelFrame(this.updatePoint)}}function transformPoint(t,e){return e?{point:e(t.point)}:t}function subtractPoint(t,e){return{x:t.x-e.x,y:t.y-e.y}}function getPanInfo({point:t},e){return{point:t,delta:subtractPoint(t,lastDevicePoint(e)),offset:subtractPoint(t,startDevicePoint(e)),velocity:getVelocity(e,.1)}}function startDevicePoint(t){return t[0]}function lastDevicePoint(t){return t[t.length-1]}function getVelocity(t,e){if(t.length<2)return{x:0,y:0};let n=t.length-1,i=null;const s=lastDevicePoint(t);for(;n>=0&&(i=t[n],!(s.timestamp-i.timestamp>timeConversion.secondsToMilliseconds(e)));)n--;if(!i)return{x:0,y:0};const o=timeConversion.millisecondsToSeconds(s.timestamp-i.timestamp);if(0===o)return{x:0,y:0};const r={x:(s.x-i.x)/o,y:(s.y-i.y)/o};return r.x===1/0&&(r.x=0),r.y===1/0&&(r.y=0),r}exports.PanSession=PanSession;
